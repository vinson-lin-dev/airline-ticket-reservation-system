<!-- CUSTOMER DASHBOARD -->

{% extends 'base.html' %}

{% block content %}
<h2 class="section-header">Welcome, {{ user_email }}!</h2>

<!-- Profile Info -->
<!-- <div class="profile-info">
    <h3>Profile Information</h3>
    <p><strong>Name:</strong> {{ customer_info['name'] }}</p>
    <p><strong>Email:</strong> {{ customer_info['email'] }}</p>
    <p><strong>Passport Number:</strong> {{ customer_info['passport_number'] }}</p>
    <p><strong>Date of Birth:</strong> {{ customer_info['date_of_birth'] }}</p>
</div> -->

<!-- Upcoming Flights -->
<div class="upcoming-flights">
    <h3 class="section-header">Your Upcoming Flights</h3>
    {% if upcoming_flights %}
        <table>
            <thead>
                <tr>
                    <th>Airline Name</th>
                    <th>Flight Number</th>
                    <th>Departure Airport</th>
                    <th>Departure Time</th>
                    <th>Arrival Airport</th>
                    <th>Arrival Time</th>
                    <th>Status</th>
                    <!-- <th>Price</th> -->
                </tr>
            </thead>
            <tbody>
                {% for flight in upcoming_flights %}
                <tr>
                    <td>{{ flight['airline_name'] }}</td>
                    <td>{{ flight['flight_num'] }}</td>
                    <td>{{ flight['departure_airport'] }}</td>
                    <td>{{ flight['departure_time'] }}</td>
                    <td>{{ flight['arrival_airport'] }}</td>
                    <td>{{ flight['arrival_time'] }}</td>
                    <td>{{ flight['status'] }}</td>
                    <!-- <td>{{ flight['price'] }}</td> -->
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>You have no upcoming flights.</p>
    {% endif %}
</div>

<!-- Flight Search -->
<div class="search-flights">
    <h3 class="section-header">Search for a New Flight To Purchase</h3>
    <form action="{{ url_for('search_flights') }}" method="get">
        <label for="source">Departure Airport:</label>
        <input type="text" id="source" name="source" list="departure_airports" placeholder="Departure Airport" required>

        <label for="destination">Arrival Airport:</label>
        <input type="text" id="destination" name="destination" list="arrival_airports" placeholder="Arrival Airport" required>

        <label for="date">Date:</label>
        <input type="date" id="date" name="date" required>

        <button type="submit">Search Flights</button>
    </form>
</div>

<datalist id="departure_airports">
    {% for airport in departure_airports %}
    <option value="{{ airport['departure_airport'] }}">
    {% endfor %}
</datalist>

<datalist id="arrival_airports">
    {% for airport in arrival_airports %}
    <option value="{{ airport['arrival_airport'] }}">
    {% endfor %}
</datalist>

<!-- Booking History -->
<div class="booking-history">
    <h3 class="section-header">Your Booking History</h3>
    {% if booking_history %}
        <table>
            <thead>
                <tr>
                    <th>Booking Date</th>
                    <th>Airline Name</th>
                    <th>Flight Number</th>
                    <th>Departure Airport</th>
                    <th>Arrival Airport</th>
                    <th>Status</th>
                    <th>Price</th>
                </tr>
            </thead>
            <tbody>
                {% for booking in booking_history %}
                <tr>
                    <td>{{ booking['purchase_date'] }}</td>
                    <td>{{ booking['airline_name'] }}</td>
                    <td>{{ booking['flight_num'] }}</td>
                    <td>{{ booking['departure_airport'] }}</td>
                    <td>{{ booking['arrival_airport'] }}</td>
                    <td>{{ booking['status'] }}</td>
                    <td>{{ booking['price'] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>You have no past bookings.</p>
    {% endif %}
</div>

<!-- Spending Tracker -->
<div class="spending-tracker">
    <h3 class="section-header">Your Spending</h3>
    <div>
        <h4>Total Spending in the Last Year: ${{ total_spent_last_year if total_spent_last_year else 0 }}</h4>
        <h4>Total Spending in the Last 6 Months: ${{ total_spent_last_six_months if total_spent_last_six_months else 0 }}</h4>
    </div>

    <!-- Bar Chart for Last 6 Months Spending -->
    <canvas id="spendingLast6Months" width="300" height="100"></canvas>

    <h4>Spending Over Time</h4>
    <form method="POST" action="/customer_dashboard">
        <label for="start_date">Start Date:</label>
        <input type="date" name="start_date" required>
        <label for="end_date">End Date:</label>
        <input type="date" name="end_date" required>
        <button type="submit">Show Spending</button>
    </form>

    <!-- Bar Chart for Selected Date Range Spending -->
    <canvas id="spendingChart" width="300" height="100"></canvas>
    <!-- Display Total Spending for Selected Date Range -->
    <p id="totalSpendingDisplay"></p>

    <script>
        // Bar Chart For Spending In Last 6 Months
        var ctxLast6Months = document.getElementById('spendingLast6Months').getContext('2d');
        var spendingLast6MonthsChart = new Chart(ctxLast6Months, {
            type: 'bar',
            data: {
                labels: [
                    {% for entry in last_six_months_spending %}
                        "{{ entry['month'] }}", {% if not loop.last %},{% endif %}
                    {% endfor %}
                ],
                datasets: [{
                    label: 'Spending in Last 6 Months',
                    data: [
                        {% for entry in last_six_months_spending %}
                            {{ entry['total_spent'] or 0 }},
                            {% if not loop.last %},{% endif %}
                        {% endfor %}
                    ],
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                responsive: true
            }
        });

        // Bar Chart For Spending Over Time Range
        var ctxSelectedRange = document.getElementById('spendingChart').getContext('2d');
        var spendingChart = new Chart(ctxSelectedRange, {
            type: 'bar',
            data: {
                labels: [
                    {% for entry in monthly_spending %}
                        "{{ entry['month'] }}", {% if not loop.last %},{% endif %}
                    {% endfor %}
                ],
                datasets: [{
                    label: 'Amount Spent',
                    data: [
                        {% for entry in monthly_spending %}
                            {{ entry['total_spent'] }},
                            {% if not loop.last %},{% endif %}
                        {% endfor %}
                    ],
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                responsive: true
            }
        });

        // Display Total Spending for Selected Date Range
        var totalSpendingElement = document.getElementById('totalSpendingDisplay');
        totalSpendingElement.innerHTML = `Total Spending: ${{ total_spent_range }} (for tickets bought between {{ start_date }} and {{ end_date }})`;
    </script>
    
</div>

{% endblock %}
